<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="../images/logo.png" />
    <link rel="stylesheet" href="../styles/main.css" />
    <title>Add Article | Dashboard | Shema's Blog</title>
  </head>
  <body>
    <header class="navigation" id="home">
      <nav class="container py-4">
        <div class="logo">
          <h1 class="m-0">/ Fred /</h1>
        </div>
        <div class="toggle">
          <div class="line"></div>
          <div class="line"></div>
          <div class="line"></div>
        </div>
        <ul class="nav-links">
          <li class="nav-link"><a href="dashboard.html">Dashboard</a></li>
          <li class="nav-link"><a href="../index.html">Logout</a></li>
        </ul>
      </nav>
    </header>
    <section id="body-content">
      <div class="container py-5">
        <div class="text-center">
          <h1 class="text-lg mt-0 mb-3">New Blog</h1>
          <p class="my-0">Write a new blog and publish it to the world</p>
        </div>

        <form action="dashboard.html" class="form" id="add-blog-form">
          <div class="form-group">
            <div class="form-control">
              <label for="title">Title</label>
              <input type="text" name="title" id="title" />
              <span id="error" class="text-danger hide text-sm"></span>
            </div>
          </div>
          <div class="form-group">
            <div class="form-control">
              <label for="content">Content</label>
              <textarea name="content" id="content" rows="10"></textarea>
              <span id="error" class="text-danger hide text-sm"></span>
            </div>
          </div>
          <div class="form-group">
            <div class="form-file">
              <label for="image">
                <img src="../images/upload-file.svg" alt="" />
                <span>Select an image for your blog</span>
              </label>
              <input
                type="file"
                name="image"
                id="image"
                placeholder="Select"
                style="display: none"
              />
              <span id="error" class="text-danger hide text-sm"></span>
            </div>
          </div>

          <div class="form-group">
            <div class="form-control">
              <button type="submit" class="btn btn-block">Publish</button>
            </div>
          </div>
        </form>
      </div>
    </section>
    <script src="../scripts/responsive.js"></script>
    <script>
      const processImage = (id, input) => {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const articles = JSON.parse(localStorage.getItem("articles")) || [];
            const article = articles.find((article) => article.id === id);
            article.image = e.target.result;
            localStorage.setItem("articles", JSON.stringify(articles));
          };
          reader.readAsDataURL(input.files[0]);
        }
      };
      window.addEventListener("load", function () {
        const form = document.querySelector("#add-blog-form");
        const title = document.querySelector("#title");
        const content = document.querySelector("#content");
        const image = document.querySelector("#image");
        const titleError = document.querySelector("#title + span");
        const contentError = document.querySelector("#content + span");
        const imageError = document.querySelector("#image + span");

        title.addEventListener("keyup", function () {
          if (!titleError.classList.contains("hide")) {
            titleError.classList.add("hide");
          }
        });

        content.addEventListener("keyup", function () {
          if (!contentError.classList.contains("hide")) {
            contentError.classList.add("hide");
          }
        });

        image.addEventListener("change", function () {
          if (!imageError.classList.contains("hide")) {
            imageError.classList.add("hide");
          }
        });

        form.addEventListener("submit", function (e) {
          e.preventDefault();

          let valid = true;

          if (title.value.trim() === "") {
            titleError.classList.remove("hide");
            titleError.innerHTML = "Title is required";
            valid = false;
          }

          if (content.value.trim() === "") {
            contentError.classList.remove("hide");
            contentError.innerHTML = "Content is required";
            valid = false;
          }

          if (image.value.trim() === "") {
            imageError.classList.remove("hide");
            imageError.innerHTML = "Image is required";
            valid = false;
          }

          if (!valid) return;

          const formAction = form.getAttribute("action");
          const id = new Date().getTime();
          const article = {
            id,
            title: title.value,
            content: content.value,
            image: processImage(id, image),
            reads: 0,
            likes: 0,
            comments: 0,
            createdAt: new Date().toDateString(),
          };

          const articles = JSON.parse(localStorage.getItem("articles")) || [];
          articles.push(article);
          localStorage.setItem("articles", JSON.stringify(articles));
          window.location.href = formAction;
        });
      });
    </script>
  </body>
</html>
